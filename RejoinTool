#!/data/data/com.termux/files/usr/bin/bash
# Script Roblox Toàn Diện: Tối ưu hóa để chạy ổn định trên Android có root.
# LOGIC: Dừng ứng dụng một cách an toàn -> Wake Lock -> Vòng lặp làm mới trong 3 giờ -> Tự khởi động lại.
#---------------------------------------------------
# -- CÀI ĐẶT CHÍNH --
#---------------------------------------------------

# Liên kết hậu tố phiên bản với ID tài khoản Roblox tương ứng.
# Định dạng: "hậu_tố_1:ID_1 hậu_tố_2:ID_2 ..."
# VÍ DỤ: AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342 g:8825003633"
AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342 g:8825003633"

# URL của VIP Server bạn muốn tham gia
VipServerUrl="roblox://placeId=8737602449"

# Thời gian (giây) giữa mỗi chu kỳ kiểm tra/làm mới (300 giây = 5 phút)
CycleInterval=300

# Thời gian (giây) để script tự khởi động lại (10800 giây = 3 giờ)
RestartInterval=10800

# Thời gian (giây) chờ giữa mỗi lần gửi lệnh join
OpenDelay=10

# Tên gói cơ bản của Roblox (không nên thay đổi)
BasePackageName="com.roblox.client"

#---------------------------------------------------
# -- TỰ ĐỘNG KIỂM TRA ROOT --
#---------------------------------------------------
# Script sẽ tự động yêu cầu quyền root nếu chưa có
if [[ $EUID -ne 0 ]]; then
    echo "Script này cần quyền root để thực thi 'am force-stop'."
    echo "Đang cố gắng chạy lại script với 'su'..."
    # <<< THAY ĐỔI: Đảm bảo đường dẫn và đối số được truyền chính xác
    su -c "bash \"$0\" \"$@\""
    exit 0
fi

#---------------------------------------------------
# -- LOGIC CHÍNH --
#---------------------------------------------------

# <<< TỐI ƯU: Hàm dừng ứng dụng bằng 'am force-stop' - phương pháp an toàn cho Android
# Thay vì 'kill -9', chúng ta yêu cầu hệ thống Android tự đóng ứng dụng.
function stop_instance() {
    local package_name="$1"
    echo "   => Dừng phiên bản $package_name một cách an toàn..."
    am force-stop "$package_name" >/dev/null 2>&1
    sleep 2 # Thêm độ trễ nhỏ để hệ thống xử lý
}

# Hàm tắt toàn bộ các phiên bản
function stop_all_instances() {
    read -r -a account_pairs <<< "$AccountMap"
    if [[ ${#account_pairs[@]} -eq 0 ]]; then return; fi

    echo "Đang dừng tất cả các phiên bản Roblox..."
    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        package_to_stop="${BasePackageName}${suffix}"
        stop_instance "$package_to_stop"
    done
    echo "Đã hoàn tất việc dừng các phiên bản."
}

# Hàm chính để kiểm tra và làm mới
function refresh_instances() {
    echo "================================================="
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] BẮT ĐẦU CHU KỲ LÀM MỚI..."

    read -r -a account_pairs <<< "$AccountMap"

    if [[ ${#account_pairs[@]} -eq 0 ]]; then
        echo "Lỗi: Vui lòng định nghĩa ít nhất một cặp hậu_tố:ID trong biến 'AccountMap'."
        return
    fi

    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        user_id="${pair##*:}"
        package_name="${BasePackageName}${suffix}"

        echo "---"
        echo "-> Đang kiểm tra phiên bản '$suffix' (ID: $user_id)..."

        PRESENCE_API="https://presence.roblox.com/v1/presence/users"
        PRESENCE_PAYLOAD="{\"userIds\": [$user_id]}"
        
        # <<< TỐI ƯU: Thêm kiểm tra lỗi cho lệnh curl
        PRESENCE_DATA_RAW=$(curl --max-time 10 -s -X POST -H "Content-Type: application/json" -d "$PRESENCE_PAYLOAD" "$PRESENCE_API")
        
        if [[ -z "$PRESENCE_DATA_RAW" ]]; then
            echo "   -> Lỗi: Không nhận được phản hồi từ Roblox API. Bỏ qua lần kiểm tra này."
            continue # Bỏ qua tài khoản này và chuyển đến tài khoản tiếp theo
        fi
        
        # <<< TỐI ƯU: Cách lấy 'userPresenceType' ổn định hơn một chút
        PRESENCE_TYPE=$(echo "$PRESENCE_DATA_RAW" | grep -o '"userPresenceType":[0-9]*' | cut -d':' -f2)

        if [[ "$PRESENCE_TYPE" != "2" ]]; then
            echo "   -> Trạng thái: NOT IN GAME (Code: ${PRESENCE_TYPE:-N/A}). Khởi động lại phiên bản..."
            # Dừng phiên bản hiện tại một cách an toàn trước khi khởi chạy lại
            stop_instance "$package_name"
        else
            echo "   -> Trạng thái: IN GAME (Code: 2). Gửi lệnh join để làm mới..."
        fi

        echo "   => Gửi lệnh join đến: $package_name"
        am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"
        sleep "$OpenDelay"
    done
}

# --- ĐIỂM KHỞI ĐẦU CỦA SCRIPT ---
clear
echo "--- KHỞI ĐỘNG CHU KỲ MỚI (3 GIỜ) ---"
stop_all_instances
sleep 5

echo "Kích hoạt Wake Lock để chống crash..."
termux-wake-lock

# Tính toán số lần lặp trong một chu kỳ 3 giờ
num_cycles=$((RestartInterval / CycleInterval))

# Vòng lặp chính, chạy trong 3 giờ
for (( i=1; i<=num_cycles; i++ )); do
    clear
    echo "--- Chu kỳ làm mới $i/$num_cycles (trong chu kỳ 3 giờ) ---"
    refresh_instances
    
    echo "================================================="
    echo "Đã hoàn tất. Script sẽ chờ $CycleInterval giây trước khi làm mới lại."
    sleep "$CycleInterval"
done

# Sau khi hoan tất vòng lặp 3 giờ, tự khởi động lại script
echo "================================================="
echo "ĐÃ HOÀN TẤT CHU KỲ 3 GIỜ. ĐANG TỰ KHỞI ĐỘNG LẠI SCRIPT..."
echo "================================================="
termux-wake-unlock # Tạm thời mở khóa trước khi chạy lại
sleep 5
exec "$0" "$@"
