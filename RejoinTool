#!/data/data/com.termux/files/usr/bin/bash
# Script Roblox All-in-One: Dinh ky lam moi phien, tu dong rejoin khi offline.
# LOGIC: Wake Lock -> Vong lap (Kiem tra tung tai khoan -> Kill & Rejoin neu offline, Force Rejoin neu online) -> Doi.
#---------------------------------------------------
# -- CAI DAT CHINH --
#---------------------------------------------------

# Lien ket hau to phien ban voi ID tai khoan Roblox tuong ung.
# Dinh dang: "hau_to_1:ID_1 hau_to_2:ID_2 ..."
AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342 g:8825003633"
AccountMap="b:2061769761"

# URL cua VIP Server ban muon tham gia
VipServerUrl="roblox://placeId=8737602449"

# Thoi gian (giay) giua moi chu ky lam moi (300 giay = 5 phut)
CycleInterval=300

# Thoi gian (giay) cho giua moi lan gui lenh join
OpenDelay=10

# Ten goi co ban cua Roblox (khong nen thay doi)
BasePackageName="com.roblox.clien"

#---------------------------------------------------
# -- TU DONG KIEM TRA ROOT --
#---------------------------------------------------
if [[ $EUID -ne 0 ]]; then
    echo "Script nay can quyen root de thuc thi 'kill'."
    echo "Dang co gang chay lai script voi 'su'..."
    su -c "bash \"$0\" \"$@\""
    exit 0
fi

#---------------------------------------------------
# -- LOGIC CHINH --
# Khong can sua phan duoi day.
#---------------------------------------------------

echo "--- KHOI DONG SCRIPT QUAN LY & LAM MOI ROBLOX ---"

# Kich hoat Wake Lock de giu cho Termux luon chay
echo "Dang kich hoat Wake Lock de chong crash..."
termux-wake-lock &

echo "Chu ky lam moi phien: $CycleInterval giay."

# Ham chinh de kiem tra va lam moi
function refresh_instances() {
    echo "================================================="
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] BAT DAU CHU KY LAM MOI..."

    read -r -a account_pairs <<< "$AccountMap"

    if [[ ${#account_pairs[@]} -eq 0 ]]; then
        echo "Loi: Vui long dinh nghia it nhat mot cap hau_to:ID trong bien 'AccountMap'."
        return
    fi

    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        user_id="${pair##*:}"
        package_name="${BasePackageName}${suffix}"

        echo "---"
        echo "-> Dang kiem tra phien ban '$suffix' (ID: $user_id)..."

        PRESENCE_API="https://presence.roblox.com/v1/presence/users"
        PRESENCE_PAYLOAD="{\"userIds\": [$user_id]}"
        # THEM TIMEOUT 10 GIÂY CHO CURL DE TRÁNH TREO
        PRESENCE_DATA_RAW=$(curl --max-time 10 -s -X POST -H "Content-Type: application/json" -d "$PRESENCE_PAYLOAD" "$PRESENCE_API")
        
        PRESENCE_TYPE=$(echo "$PRESENCE_DATA_RAW" | grep -o '"userPresenceType":[0-9]*' | sed 's/"userPresenceType"://')

        # Ma "2" la "In Game".
        if [[ "$PRESENCE_TYPE" -ne 2 ]]; then
            # NEU KHONG O TRONG GAME -> TAT VA BAT LAI
            echo "   -> Trang thai: NOT IN GAME (Code: ${PRESENCE_TYPE:-N/A}). Khoi dong lai phien ban..."
            
            pid_to_kill=$(pidof "$package_name")
            if [[ -n "$pid_to_kill" ]]; then
                echo "      => Dang tat phien ban $package_name (PID: $pid_to_kill)."
                kill -9 "$pid_to_kill"
                sleep 3
            fi
        else
            # NEU DANG O TRONG GAME -> CHI GUI LENH JOIN DE LAM MOI
            echo "   -> Trang thai: IN GAME (Code: 2). Gui lenh join de lam moi..."
        fi

        # Luon luon gui lenh join trong ca hai truong hop
        echo "      => Gui lenh join den: $package_name"
        am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"
        sleep "$OpenDelay"
    done
}

# Vong lap chinh, chay vo han
while true; do
    clear
    refresh_instances
    echo "================================================="
    echo "Da hoan tat chu ky. Script se cho $CycleInterval giay truoc khi lam moi lai."
    sleep "$CycleInterval"
done

exit 0
