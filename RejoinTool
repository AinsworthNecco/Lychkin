#!/data/data/com.termux/files/usr/bin/bash
# Script Roblox Toàn Diện: Tối ưu hóa để chạy ổn định trên Android có root.
# LOGIC: Dừng ứng dụng một cách an toàn -> Wake Lock -> Vòng lặp làm mới trong 3 giờ -> Tự khởi động lại.
# PHIÊN BẢN 3: Sử dụng 'monkey' để khởi chạy ứng dụng một cách ổn định.
#---------------------------------------------------
# -- CÀI ĐẶT CHÍNH --
#---------------------------------------------------

# Liên kết hậu tố phiên bản với ID tài khoản Roblox tương ứng.
# Định dạng: "hậu_tố_1:ID_1 hậu_tố_2:ID_2 ..."
# VÍ DỤ: AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342 g:8825003633"
AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342 g:8825003633"

# URL của VIP Server bạn muốn tham gia
VipServerUrl="roblox://placeId=8737602449"

# Thời gian (giây) giữa mỗi chu kỳ kiểm tra/làm mới (300 giây = 5 phút)
CycleInterval=300

# Thời gian (giây) để script tự khởi động lại (10800 giây = 3 giờ)
RestartInterval=10800

# Thời gian (giây) chờ sau khi khởi chạy app và trước khi gửi lệnh join
LaunchDelay=15
# Thời gian (giây) chờ giữa mỗi lần gửi lệnh join cho các tài khoản
OpenDelay=10

# Tên gói cơ bản của Roblox (không nên thay đổi)
BasePackageName="com.roblox.client"

#---------------------------------------------------
# -- TỰ ĐỘNG KIỂM TRA ROOT --
#---------------------------------------------------
if [[ $EUID -ne 0 ]]; then
    echo "Script này cần quyền root để thực thi các lệnh 'am' và 'monkey'."
    echo "Đang cố gắng chạy lại script với 'su'..."
    su -c "bash \"$0\" \"$@\""
    exit 0
fi

#---------------------------------------------------
# -- LOGIC CHÍNH --
#---------------------------------------------------

# Hàm dừng ứng dụng được cải tiến
function stop_instance() {
    local package_name="$1"
    if pgrep -f "$package_name" >/dev/null; then
        echo "   => Phát hiện $package_name đang chạy. Dừng một cách an toàn..."
        # <<< SỬA LỖI: Thêm --user 0 để đảm bảo dừng đúng ứng dụng của người dùng
        am force-stop --user 0 "$package_name" >/dev/null 2>&1
        sleep 3 # Tăng độ trễ để hệ thống xử lý triệt để
    else
        echo "   => Phiên bản $package_name đã dừng."
    fi
}

# Hàm tắt toàn bộ các phiên bản
function stop_all_instances() {
    read -r -a account_pairs <<< "$AccountMap"
    if [[ ${#account_pairs[@]} -eq 0 ]]; then return; fi

    echo "Đang dừng tất cả các phiên bản Roblox..."
    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        package_to_stop="${BasePackageName}${suffix}"
        stop_instance "$package_to_stop"
    done
    echo "Đã hoàn tất việc dừng các phiên bản."
}

# Hàm chính để kiểm tra và làm mới
function refresh_instances() {
    echo "================================================="
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] BẮT ĐẦU CHU KỲ LÀM MỚI..."

    read -r -a account_pairs <<< "$AccountMap"

    if [[ ${#account_pairs[@]} -eq 0 ]]; then
        echo "Lỗi: Vui lòng định nghĩa ít nhất một cặp hậu_tố:ID trong biến 'AccountMap'."
        return
    fi

    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        user_id="${pair##*:}"
        package_name="${BasePackageName}${suffix}"

        echo "---"
        echo "-> Đang kiểm tra phiên bản '$suffix' (ID: $user_id)..."

        PRESENCE_API="https://presence.roblox.com/v1/presence/users"
        PRESENCE_PAYLOAD="{\"userIds\": [$user_id]}"
        
        PRESENCE_DATA_RAW=$(curl --max-time 10 -s -X POST -H "Content-Type: application/json" -d "$PRESENCE_PAYLOAD" "$PRESENCE_API")
        
        if [[ -z "$PRESENCE_DATA_RAW" ]]; then
            echo "   -> Lỗi: Không nhận được phản hồi từ Roblox API. Bỏ qua lần kiểm tra này."
            continue 
        fi
        
        PRESENCE_TYPE=$(echo "$PRESENCE_DATA_RAW" | grep -o '"userPresenceType":[0-9]*' | cut -d':' -f2)

        if [[ "$PRESENCE_TYPE" != "2" ]]; then
            echo "   -> Trạng thái: NOT IN GAME (Code: ${PRESENCE_TYPE:-N/A}). Khởi động lại phiên bản..."
            stop_instance "$package_name"
            
            # <<< SỬA LỖI LỚN: Sử dụng 'monkey' để khởi chạy ứng dụng
            # Bước 1: Dùng monkey để khởi chạy gói ứng dụng. Cách này ổn định hơn 'am start'.
            echo "   => Bước 1/2: Khởi chạy $package_name bằng monkey..."
            monkey -p "$package_name" 1 >/dev/null 2>&1
            
            # Chờ ứng dụng tải xong
            echo "   => Chờ $LaunchDelay giây để ứng dụng khởi động hoàn tất..."
            sleep "$LaunchDelay"
            
            # Bước 2: Gửi Intent để join server
            echo "   => Bước 2/2: Gửi lệnh join server đến $package_name..."
            am start --user 0 -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"

        else
            echo "   -> Trạng thái: IN GAME (Code: 2). Gửi lệnh join để làm mới..."
            echo "   => Gửi lệnh join đến: $package_name"
            am start --user 0 -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"
        fi

        sleep "$OpenDelay"
    done
}

# --- ĐIỂM KHỞI ĐẦU CỦA SCRIPT ---
clear
echo "--- KHỞI ĐỘNG CHU KỲ MỚI (3 GIỜ) ---"
stop_all_instances
sleep 5

echo "Kích hoạt Wake Lock để chống crash..."
termux-wake-lock

# Tính toán số lần lặp trong một chu kỳ 3 giờ
num_cycles=$((RestartInterval / CycleInterval))

# Vòng lặp chính, chạy trong 3 giờ
for (( i=1; i<=num_cycles; i++ )); do
    clear
    echo "--- Chu kỳ làm mới $i/$num_cycles (trong chu kỳ 3 giờ) ---"
    refresh_instances
    
    echo "================================================="
    echo "Đã hoàn tất. Script sẽ chờ $CycleInterval giây trước khi làm mới lại."
    sleep "$CycleInterval"
done

# Sau khi hoan tất vòng lặp 3 giờ, tự khởi động lại script
echo "================================================="
echo "ĐÃ HOÀN TẤT CHU KỲ 3 GIỜ. ĐANG TỰ KHỞI ĐỘNG LẠI SCRIPT..."
echo "================================================="
termux-wake-unlock # Tạm thời mở khóa trước khi chạy lại
sleep 5
exec "$0" "$@"

