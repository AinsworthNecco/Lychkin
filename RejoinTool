#!/data/data/com.termux/files/usr/bin/bash
# Script Roblox Toan Dien: Tu dong khoi dong lai sau moi 3 gio de dam bao on dinh.
# PHIEN BAN NANG CAO V3 (STABLE): Ket hop khoi dong lai Roblox (3h) va khoi dong lai toan bo script (5h).
#---------------------------------------------------
# -- CAI DAT CHINH --
#---------------------------------------------------

# ## CONG TAC CHUC NANG ##
# Dat la "ON" de su dung logic kiem tra thong minh (khuyen khich).
# Dat la "OFF" de chi gui lenh join moi 5 phut (khong kiem tra, che do mac dinh cua ban).
CheckOnlineStatus="OFF"

# Lien ket hau to phien ban voi ID tai khoan Roblox tuong ung.
AccountMap="b:8033531994 c:8033535049 d:8033528354 e:8033544205 f:8033543342"

# URL cua VIP Server ban muon tham gia
VipServerUrl="roblox://placeId=8737602449"

# Thoi gian (giay) giua moi chu ky kiem tra/lam moi (300 giay = 5 phut)
CycleInterval=300

# Thoi gian (giay) de DONG TOAN BO ROBLOX (10800 giay = 3 gio)
RestartRobloxInterval=60

# Thoi gian (giay) de KHOI DONG LAI TOAN BO SCRIPT (18000 giay = 5 gio)
# Day la bien phap quan trong nhat de tranh loi "Bad system call".
RestartScriptInterval=10800

# Thoi gian (giay) cho giua moi lan gui lenh join
OpenDelay=15

# Ten goi co ban cua Roblox (khong nen thay doi)
BasePackageName="com.roblox.clien"

#---------------------------------------------------
# -- TU DONG KIEM TRA --
#---------------------------------------------------
# Kiem tra quyen root
if [[ $EUID -ne 0 ]]; then
    echo "Script nay can quyen root. Dang co gang chay lai voi 'su'..."
    # Su dung exec de thay the tien trinh hien tai, tranh tao ra shell long nhau
    exec su -c "bash \"$0\" \"$@\""
    exit 0
fi

#---------------------------------------------------
# -- LOGIC CHINH --
#---------------------------------------------------

# Ham tat toan bo cac phien ban
function kill_all_instances() {
    echo "Dang dung tat ca cac phien ban Roblox dang chay..."
    read -r -a account_pairs <<< "$AccountMap"
    if [[ ${#account_pairs[@]} -eq 0 ]]; then return; fi

    for pair in "${account_pairs[@]}"; do
        suffix="${pair%%:*}"
        package_to_stop="${BasePackageName}${suffix}"
        
        # ## [SUA DOI 1] THAY THE 'kill -9' BANG 'am force-stop' ##
        # 'am force-stop' la cach chuan cua Android de dong ung dung, don dep tai nguyen tot hon.
        echo "  => Dung phien ban $package_to_stop bang 'am force-stop'."
        am force-stop "$package_to_stop" >/dev/null 2>&1
    done
    
    # ## [SUA DOI 2] THEM THOI GIAN NGHI NGAN ##
    # Cho he dieu hanh vai giay de hoan tat viec don dep tai nguyen.
    echo "Da gui lenh dung. Cho 5 giay de he thong on dinh..."
    sleep 5
    echo "Da hoan tat viec dung cac phien ban."
}

# Ham chinh de kiem tra va lam moi
function refresh_instances() {
    echo "================================================="
    read -r -a account_pairs <<< "$AccountMap"
    if [[ ${#account_pairs[@]} -eq 0 ]]; then
        echo "Loi: Vui long dinh nghia it nhat mot cap hau_to:ID trong bien 'AccountMap'."
        return
    fi

    if [[ "$CheckOnlineStatus" == "ON" ]]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] BAT DAU CHU KY KIEM TRA (Che do: THONG MINH)..."
        for pair in "${account_pairs[@]}"; do
            suffix="${pair%%:*}"
            user_id="${pair##*:}"
            package_name="${BasePackageName}${suffix}"

            echo "---"
            echo "-> Dang kiem tra phien ban '$suffix' (ID: $user_id)..."

            pid_is_running=$(ps -ef | grep "$package_name" | grep -v grep | awk '{print $2}')
            PRESENCE_API="https://presence.roblox.com/v1/presence/users"
            PRESENCE_PAYLOAD="{\"userIds\": [$user_id]}"
            PRESENCE_DATA_RAW=$(curl --max-time 10 -s -X POST -H "Content-Type: application/json" -d "$PRESENCE_PAYLOAD" "$PRESENCE_API")
            PRESENCE_TYPE=$(echo "$PRESENCE_DATA_RAW" | grep -o '"userPresenceType":[0-9]*' | sed 's/"userPresenceType"://')
            
            if [[ -n "$pid_is_running" ]]; then
                if [[ "$PRESENCE_TYPE" == "2" ]]; then
                    echo "   -> Trang thai: DANG CHAY & IN GAME (Code: 2). Khong can lam gi."
                else
                    echo "   -> Trang thai: DANG CHAY NHUNG NOT IN GAME (Code: ${PRESENCE_TYPE:-N/A}). Cho chu ky sau."
                fi
            else
                if [[ "$PRESENCE_TYPE" == "2" ]]; then
                    echo "   -> Trang thai: KHONG CHAY NHUNG API BAO IN GAME (Code: 2). Khoi dong lai."
                else
                    echo "   -> Trang thai: KHONG CHAY & NOT IN GAME (Code: ${PRESENCE_TYPE:-N/A}). Khoi dong phien ban..."
                fi
                echo "      => Gui lenh join den: $package_name"
                am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"
                sleep "$OpenDelay"
            fi
        done
    else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] BAT DAU CHU KY GUI LENH (Che do: DON GIAN)..."
        for pair in "${account_pairs[@]}"; do
            suffix="${pair%%:*}"
            package_name="${BasePackageName}${suffix}"
            echo "---"
            echo "-> Che do don gian: Gui lenh join den '$suffix' ($package_name)"
            am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_name"
            sleep "$OpenDelay"
        done
    fi
}

# --- DIEM KHOI DAU CUA SCRIPT ---
clear
echo "--- KHOI DONG CHU KY MOI (${RestartScriptInterval} giay) ---"
kill_all_instances
sleep 5

echo "Kich hoat Wake Lock de giu cho thiet bi thuc..."
pkill -f termux-wake-lock
termux-wake-lock &

# Tinh toan so lan lap trong mot chu ky KHOI DONG LAI SCRIPT
num_cycles_total=$((RestartScriptInterval / CycleInterval))
# Tinh toan so lan lap truoc khi KHOI DONG LAI ROBLOX
num_cycles_roblox_restart=$((RestartRobloxInterval / CycleInterval))

# Vong lap chinh, chay trong `RestartScriptInterval` giay
for (( i=1; i<=num_cycles_total; i++ )); do
    clear
    
    # Kiem tra xem co phai thoi diem de khoi dong lai toan bo Roblox khong
    if (( i % num_cycles_roblox_restart == 1 && i > 1 )); then
        echo "--- DA DAT NGUONG ${RestartRobloxInterval} GIÂY ---"
        echo "--- KHOI DONG LAI TOAN BO CAC PHIEN BAN ROBLOX ---"
        kill_all_instances
        sleep 5
    fi

    echo "--- Chu ky $i/$num_cycles_total (trong chu ky ${RestartScriptInterval} giay) ---"
    refresh_instances
    
    echo "================================================="
    echo "Da hoan tat. Script se cho $CycleInterval giay truoc khi chay lai."
    sleep "$CycleInterval"
done

# Sau khi hoan tat vong lap `RestartScriptInterval` giay, tu khoi dong lai script
echo "================================================="
echo "DA HOAN TAT CHU KY ${RestartScriptInterval} GIÂY. DANG TU KHOI DONG LAI TOAN BO SCRIPT..."
echo "================================================="
pkill -f termux-wake-lock
sleep 3
exec "$0" "$@"

