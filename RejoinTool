#!/data/data/com.termux/files/usr/bin/bash
# Script quan ly toan dien chu trinh cua Roblox, PHIEN BAN CAI TIEN v2.
# Su dung pgrep/pkill de tang do tin cay khi kiem tra va dung tien trinh.
# Giai doan 1: Mo va dam bao tat ca cac phien ban deu chay.
# Giai doan 2: Khoi dong lai tuan tu (staggered restart) tung phien ban mot trong mot vong lap vo tan.
#---------------------------------------------------
# -- CAI DAT CHINH --
# Tat ca cac tuy chinh deu o day. De de nhin hon, chu thich duoc dat sau moi bien.
#---------------------------------------------------

# --- CAI DAT CHUNG ---
Suffixes="b c d e f"          # Cac hau to phien ban muon mo (phan cach boi dau cach).
VipServerUrl="roblox://placeId=8737602449" # URL cua VIP Server ban muon tham gia.

# --- GIAI DOAN 1: KHOI DONG & XAC MINH ---
InitialOpenDelay=10           # (Giay) Thoi gian cho giua moi lan mo phien ban trong lan dau.
VerificationInterval=20       # (Giay) Thoi gian cho giua moi lan kiem tra cac phien ban con thieu.

# --- GIAI DOAN 2: KHOI DONG LAI TUAN TU ---
StaggeredRestartDelay=600     # (Giay) Thoi gian cho truoc khi tat/mo lai phien ban TIEP THEO (600s = 10 phut).

# --- CAI DAT HE THONG (Khong nen thay doi) ---
BasePackageName="com.roblox.clien"

#---------------------------------------------------
# -- KIEM TRA CONG CU CAN THIET --
#---------------------------------------------------
if ! command -v pgrep &> /dev/null; then
    echo "Loi: Lenh 'pgrep' khong duoc tim thay. Day la mot phan cua 'procps'."
    echo "Vui long chay lenh sau trong Termux de cai dat:"
    echo "pkg install procps"
    exit 1
fi

#---------------------------------------------------
# -- TU DONG KIEM TRA ROOT --
#---------------------------------------------------
if [[ $EUID -ne 0 ]]; then
    echo "Script nay can quyen root de thuc thi 'pkill'."
    echo "Dang co gang chay lai script voi 'su'..."
    su -c "bash \"$0\""
    exit 0
fi

#---------------------------------------------------
# -- LOGIC CHINH --
# Khong can sua phan duoi day.
#---------------------------------------------------

echo "THANH CONG: Script dang chay voi quyen root."
echo "--- KHOI DONG SCRIPT QUAN LY ROBLOX (PHIEN BAN TUAN TU v2) ---"

# Chuyen chuoi Suffixes thanh mot mang cac ten goi day du
read -r -a suffixes_array <<< "$Suffixes"
all_packages=()
for suffix in "${suffixes_array[@]}"; do
    all_packages+=("${BasePackageName}${suffix}")
done
totalInstances=${#all_packages[@]}

if (( totalInstances == 0 )); then
    echo "Loi: Vui long dinh nghia it nhat mot hau to trong bien 'Suffixes'."
    exit 1
fi

#=================================================
# GIAI DOAN 1: MO VA XAC MINH
#=================================================
echo "[$(date '+%Y-%m-%d %H:%M:%S')] BAT DAU GIAI DOAN 1: KHOI DONG & XAC MINH."

# --- Buoc 1.1: Mo toan bo Roblox trong danh sach ---
echo "Buoc 1.1: Dang mo $totalInstances phien ban..."
for package in "${all_packages[@]}"; do
    echo "  => Dang mo: $package"
    am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package"
    echo "     ...cho $InitialOpenDelay giay."
    sleep "$InitialOpenDelay"
done

# --- Buoc 1.2: Kiem tra lien tuc cho den khi tat ca deu chay ---
echo "Buoc 1.2: Kiem tra va khoi dong lai cac phien ban con thieu..."
while true; do
    not_running_packages=()
    echo "-------------------------------------------------"
    echo "Dang quet trang thai cac phien ban (su dung pgrep)..."
    for package in "${all_packages[@]}"; do
        # Su dung pgrep -f de kiem tra tien trinh mot cach dang tin cay hon
        if ! pgrep -f "$package" > /dev/null; then
            not_running_packages+=("$package")
        fi
    done

    if (( ${#not_running_packages[@]} == 0 )); then
        echo "THANH CONG: Tat ca $totalInstances phien ban deu dang chay."
        break # Thoat vong lap kiem tra, chuyen sang Giai doan 2
    else
        echo "Phat hien ${#not_running_packages[@]} phien ban chua chay. Dang mo lai..."
        for package_to_start in "${not_running_packages[@]}"; do
            echo "  => Mo lai: $package_to_start"
            am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_to_start"
            sleep 2 # Cho mot chut sau khi mo
        done
        echo "Se kiem tra lai sau $VerificationInterval giay."
        sleep "$VerificationInterval"
    fi
done

#=================================================
# GIAI DOAN 2: KHOI DONG LAI TUAN TU
#=================================================
echo ""
echo "================================================="
echo "[$(date '+%Y-%m-%d %H:%M:%S')] BAT DAU GIAI DOAN 2: KHOI DONG LAI TUAN TU."
echo "Moi phien ban se duoc khoi dong lai sau moi $StaggeredRestartDelay giay."
echo "================================================="

# Vong lap chinh, chay vo han de khoi dong lai tuan tu
while true; do
    # Lap qua tung phien ban de khoi dong lai
    for package_to_restart in "${all_packages[@]}"; do
        echo "-------------------------------------------------"
        echo "Phien ban tiep theo se khoi dong lai la: $package_to_restart"
        echo "Dang cho $StaggeredRestartDelay giay..."
        
        sleep "$StaggeredRestartDelay"

        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Da het gio. Dang khoi dong lai $package_to_restart..."
        
        # Su dung pkill -f de dung tien trinh mot cach dang tin cay
        if pgrep -f "$package_to_restart" > /dev/null; then
            echo "  => Dung phien ban $package_to_restart bang lenh 'pkill -9 -f'."
            pkill -9 -f "$package_to_restart"
            sleep 3 # Cho de he dieu hanh giai phong process
        else
            echo "  => Phien ban $package_to_restart da tu dong, khong can 'pkill'."
        fi

        # Mo lai phien ban do
        echo "  => Mo lai phien ban $package_to_restart."
        am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_to_restart"
        echo "Da hoan tat khoi dong lai cho $package_to_restart."
    done
    echo "================================================="
    echo "DA HOAN TAT MOT CHU KY KHOI DONG LAI. Lap lai tu phien ban dau tien."
    echo "================================================="
done

exit 0
