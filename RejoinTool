#!/data/data/com.termux/files/usr/bin/bash
# Script quan ly toan dien chu trinh cua Roblox: Mo, kiem tra, duy tri, va khoi dong lai dinh ky.
# PHIEN BAN IM LANG: Loai bo tat ca 'echo', chi hoat dong ngam va gui webhook.
# b c d e f g h i j k l m n o p q r s t u v w x y z
#---------------------------------------------------
# -- CAI DAT CHINH --
#---------------------------------------------------

EnableRestartCycle=true
Suffixes="b c d e f"
VipServerUrl="roblox://placeId=8737602449"
OpenDelay=10
CheckInterval=20
RestartInterval=7200 # 7200 giay = 2 tieng
Cooldown=10
BasePackageName="com.roblox.clien"

# URL Webhook de thong bao (vd: Discord)
WebhookUrl="https://discord.com/api/webhooks/1251040771952349274/uNLajABQNI711STH8eKvzmcckjz1w_-CsJxYNkobgpSnUTIhIlxM4gaT9A6bAfT9xFdd"

# URL hinh anh cho thong bao webhook
# Hinh anh khi khoi dong thanh cong
SuccessImageUrl="https://i.pinimg.com/736x/a0/a2/f7/a0a2f7c80479aa63df402b1502847e28.jpg"
# Hinh anh khi khoi dong lai
RestartImageUrl="https://i.pinimg.com/736x/a0/a2/f7/a0a2f7c80479aa63df402b1502847e28.jpg"

#---------------------------------------------------
# -- TU DONG KIEM TRA ROOT --
#---------------------------------------------------
if [[ $EUID -ne 0 ]]; then
    su -c "bash \"$0\""
    exit 0
fi

#---------------------------------------------------
# -- HAM GUI WEBHOOK --
#---------------------------------------------------
function send_webhook() {
    # Kiem tra xem WebhookUrl co duoc cau hinh khong
    if [[ -z "$WebhookUrl" ]]; then
        return
    fi

    local message_content="$1"
    local image_url="$2"
    local embed_color=16750204 # Mau hong (Pink)

    # Tao payload JSON cho Discord Embed
    json_payload=$(cat <<EOF
{
  "content": null,
  "embeds": [
    {
      "description": "${message_content}",
      "color": ${embed_color},
      "image": {
        "url": "${image_url}"
      },
      "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
      "footer": {
        "text": "Roblox Management Script"
      }
    }
  ],
  "attachments": []
}
EOF
)

    # Gui webhook bang cURL
    curl -H "Content-Type: application/json" \
         -X POST \
         -d "$json_payload" \
         "$WebhookUrl" >/dev/null 2>&1
}


#---------------------------------------------------
# -- LOGIC CHINH --
#---------------------------------------------------
read -r -a suffixes_array <<< "$Suffixes"
all_packages=()
for suffix in "${suffixes_array[@]}"; do
    all_packages+=("${BasePackageName}${suffix}")
done
totalInstances=${#all_packages[@]}

if (( totalInstances == 0 )); then
    exit 1
fi

function open_and_check() {
    for package in "${all_packages[@]}"; do
        am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package"
        sleep "$OpenDelay"
    done

    for i in 1 2; do
        sleep "$CheckInterval"
        
        not_running_packages=()
        for package in "${all_packages[@]}"; do
            if ! pidof "$package" > /dev/null; then
                not_running_packages+=("$package")
            fi
        done

        if (( ${#not_running_packages[@]} > 0 )); then
            for package_to_start in "${not_running_packages[@]}"; do
                am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_to_start"
                sleep "$OpenDelay"
            done
        else
            break
        fi
    done
}

if [ "$EnableRestartCycle" = true ]; then
    while true; do
        open_and_check

        # --- GUI WEBHOOK KHI KHOI DONG THANH CONG ---
        initial_message="‚úÖ **KHOI DONG THANH CONG!**\n\nTat ca cac phien ban da chay.\nChu trinh se khoi dong lai sau: \`$((RestartInterval / 3600)) gio $(((RestartInterval % 3600) / 60)) phut\`"
        send_webhook "$initial_message" "$SuccessImageUrl"

        sleep "$RestartInterval"

        for package_to_stop in "${all_packages[@]}"; do
            pid_to_kill=$(pidof "$package_to_stop")
            if [[ -n "$pid_to_kill" ]]; then
                kill -9 "$pid_to_kill"
            fi
        done

        # --- GUI WEBHOOK KHI KHOI DONG LAI ---
        restart_message="‚è≥ **CHU TRINH KHOI DONG LAI**\n\nDa tat cac phien ban. Se bat dau lai sau: \`${Cooldown} giay\`"
        send_webhook "$restart_message" "$RestartImageUrl"

        sleep "$Cooldown"
    done
else
    open_and_check
    # --- GUI WEBHOOK KHI HOAN TAT (CHE DO 1 LAN) ---
    final_message="üèÅ **HOAN TAT**\n\nScript da chay xong va se ket thuc (EnableRestartCycle=false)."
    send_webhook "$final_message" "$SuccessImageUrl"
    exit 0
fi

exit 0
