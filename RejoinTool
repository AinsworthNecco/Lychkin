#!/data/data/com.termux/files/usr/bin/bash
# Script mo nhieu phien ban Roblox dua tren cau hinh san co.
# PHIEN BAN NANG CAO: Tu dong kiem tra va khoi dong lai cac phien ban chua chay.
# PHIEN BAN CAP NHAT: Tu dong tat va mo lai Roblox sau moi 2 tieng.
# b c d e f g h i j k

#---------------------------------------------------
# -- SETTINGS --
# Chinh sua cac gia tri duoi day truoc khi chay.
#---------------------------------------------------

# Them hoac xoa cac hau to phien ban ban muon mo (phan cach boi dau cach)
Suffixes="b"

# Thoi gian (giay) cho giua moi lan quet kiem tra tat ca cac phien ban
CheckInterval=20

# Thoi gian (giay) cho giua moi lan mo mot phien ban
OpenDelay=10

# THAY DOI: Thoi gian (giay) de chay lai script (2 tieng = 7200 giay)
RestartInterval=30

# URL cua VIP Server ban muon tham gia
VipServerUrl="roblox://placeId=8737602449"

# Ten goi co ban cua Roblox (khong nen thay doi)
BasePackageName="com.roblox.clien"

#---------------------------------------------------
# -- LOGIC --
# Khong can sua phan duoi day.
#---------------------------------------------------

# Chuyen chuoi Suffixes thanh mot mang cac ten goi day du
read -r -a suffixes_array <<< "$Suffixes"
all_packages=()
for suffix in "${suffixes_array[@]}"; do
    all_packages+=("${BasePackageName}${suffix}")
done

totalInstances=${#all_packages[@]}

# Kiem tra xem co hau to nao duoc khai bao khong
if (( totalInstances == 0 )); then
    echo "Loi: Vui long dinh nghia it nhat mot hau to trong bien 'Suffixes'."
    exit 1
fi

echo "--- SCRIPT KHOI DONG ---"
echo "Tong so phien ban can quan ly: $totalInstances"
echo "Script se tu dong tat va mo lai sau moi $(($RestartInterval / 3600)) tieng."

# THAY DOI: Vong lap vo han de chay lien tuc
while true; do
    echo "================================================="
    echo "--- BAT DAU LUOT MO MOI ---"
    
    # Vong lap de mo tat ca cac phien ban
    while true; do
        not_running_packages=()

        # Buoc 1: Kiem tra xem phien ban nao chua chay
        echo "-------------------------------------------------"
        echo "Dang quet trang thai..."
        for package in "${all_packages[@]}"; do
            # Su dung 'pidof' de kiem tra su ton tai cua process.
            if ! pidof "$package" > /dev/null; then
                # Neu khong tim thay PID, them vao danh sach can mo
                not_running_packages+=("$package")
                echo "   [CHUA CHAY] - $package"
            else
                echo "   [DANG CHAY]  - $package"
            fi
        done

        # Buoc 2: Kiem tra ket qua va quyet dinh hanh dong
        if (( ${#not_running_packages[@]} == 0 )); then
            # Neu danh sach can mo trong, nghia la tat ca da chay
            echo "-------------------------------------------------"
            echo "THANH CONG: Tat ca $totalInstances phien ban Roblox da duoc mo."
            break # Thoat khoi vong lap kiem tra va mo
        else
            # Neu con phien ban chua chay, bat dau mo chung
            count_not_running=${#not_running_packages[@]}
            echo "Phat hien $count_not_running phien ban chua chay. Dang tien hanh mo..."
            
            for package_to_start in "${not_running_packages[@]}"; do
                echo "   => Dang mo: $package_to_start"
                am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_to_start"
                # Cho mot chut giua cac lan mo de he thong xu ly
                echo "      ...cho $OpenDelay giay."
                sleep "$OpenDelay"
            done
            
            echo "Da hoan tat luot mo. Se kiem tra lai sau $CheckInterval giay..."
            sleep "$CheckInterval"
        fi
    done

    # THAY DOI: Buoc 3: Cho 2 tieng
    echo "-------------------------------------------------"
    echo "Tat ca phien ban da chay. Script se cho $(($RestartInterval / 3600)) tieng truoc khi khoi dong lai."
    echo "Thoi gian khoi dong lai du kien: $(date -d "+$RestartInterval seconds")"
    sleep "$RestartInterval"

    # THAY DOI: Buoc 4: Tat tat ca cac phien ban Roblox
    echo "-------------------------------------------------"
    echo "DA DEN GIO KHOI DONG LAI. Dang tat tat ca cac phien ban Roblox..."
    for package in "${all_packages[@]}"; do
        echo "   => Dang tat: $package"
        am force-stop "$package" > /dev/null 2>&1
    done
    echo "Da tat xong. Cho mot chut truoc khi bat dau lai..."
    sleep 15 # Cho 15 giay de he thong on dinh
done

exit 0
