#!/data/data/com.termux/files/usr/bin/bash

#----------------------------------------
# CONFIG
#----------------------------------------

Suffixes="b c d e f"
VipServerUrl="roblox://placeId=8737602449"
MaxRuns=3
CheckInterval=20
OpenDelay=10
BasePackageName="com.roblox.clien"

OptimizeGraphics=true      # Giam do phan giai + tat animation
AutoClearCache=true        # Bat tinh nang xoa cache
CacheClearIntervalMin=10   # Xoa cache moi X phut sau khi mo thanh cong

#----------------------------------------
# TOI UU DO HOA
#----------------------------------------

if $OptimizeGraphics; then
    wm size 64x64
    wm density 30
    settings put system window_animation_scale 0
    settings put system transition_animation_scale 0
    settings put system animator_duration_scale 0
    echo "[INFO] Da toi uu do hoa (64x64, dpi 30, tat animation)"
fi

#----------------------------------------
# KHOI TAO
#----------------------------------------

read -r -a suffixes_array <<< "$Suffixes"
all_packages=()
for suffix in "${suffixes_array[@]}"; do
    all_packages+=("${BasePackageName}${suffix}")
done

totalInstances=${#all_packages[@]}
if (( totalInstances == 0 )); then
    echo "Loi: Khong co phien ban nao duoc khai bao!"
    exit 1
fi

echo "--- BAT DAU MO $totalInstances PHIEN BAN ROBLOX ---"

#----------------------------------------
# MO CAC PHIEN BAN (chay toi da MaxRuns lan)
#----------------------------------------

run_count=0
while [[ $run_count -lt $MaxRuns ]]; do
    run_count=$((run_count + 1))
    not_running_packages=()

    echo "-------------------------------------------------"
    echo "Quet lan $run_count/$MaxRuns..."

    for package in "${all_packages[@]}"; do
        if ! pidof "$package" > /dev/null; then
            not_running_packages+=("$package")
            echo "   [CHUA CHAY] - $package"
        else
            echo "   [DANG CHAY] - $package"
        fi
    done

    if (( ${#not_running_packages[@]} == 0 )); then
        echo "Tat ca phien ban da duoc mo thanh cong."
        break
    else
        echo "Dang mo ${#not_running_packages[@]} phien ban chua chay..."

        for package_to_start in "${not_running_packages[@]}"; do
            echo "   => Mo: $package_to_start"
            am start -a android.intent.action.VIEW -d "$VipServerUrl" -p "$package_to_start"
            sleep "$OpenDelay"
        done

        if [[ $run_count -lt $MaxRuns ]]; then
            echo "Cho $CheckInterval giay truoc khi quet lai..."
            sleep "$CheckInterval"
        fi
    fi
done

#----------------------------------------
# XOAY VONG XOA CACHE DINH KY (sau khi da mo thanh cong)
#----------------------------------------

if $AutoClearCache; then
    echo "--- BAT DAU VONG LAP XOA CACHE DINH KY (${CacheClearIntervalMin}p) ---"
    while true; do
        sleep $((CacheClearIntervalMin * 60))
        echo "[$(date '+%H:%M:%S')] Dang xoa cache Roblox..."

        for package in "${all_packages[@]}"; do
            app_cache_path="/data/data/${package}/cache"
            if [ -d "$app_cache_path" ]; then
                rm -rf "${app_cache_path:?}"/*
                echo "   [CLEAR] $package"
            fi
        done
    done
else
    echo "--- SCRIPT KET THUC (KHONG BAT XOAY VONG XOA CACHE) ---"
fi

exit 0
