import os
import subprocess
import time
import sqlite3

# ================= CẤU HÌNH (Dán thông tin vào đây) =================
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PACKAGE_NAME = "com.roblox.clieng" 
PLACE_ID = "8737602449"

# Đường dẫn database theo logic thư mục Android
DB_PATH = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"
TMP_PATH = "/data/local/tmp/cookies_fixed.db" # File tạm trung gian
# ====================================================================

def run_cmd(command):
    """Sử dụng subprocess giống hệt logic trong file improvev2.py"""
    return subprocess.run(['su', '-c', command], capture_output=True, text=True)

def inject_cookie_logic():
    print(f"\033[1;96m[ Rokid Manager ] - Preparing database for {PACKAGE_NAME}...\033[0m")
    
    # Bước 1: Tắt app và xóa các file log/khóa của SQLite
    run_cmd(f"am force-stop {PACKAGE_NAME}")
    run_cmd(f"rm -f {DB_PATH}-wal")
    run_cmd(f"rm -f {DB_PATH}-shm")
    time.sleep(1)

    # Bước 2: Trích xuất database ra vùng tạm và CẤP QUYỀN GHI
    run_cmd(f"cp {DB_PATH} {TMP_PATH}")
    run_cmd(f"chmod 777 {TMP_PATH}") # Sửa lỗi Read-only bằng cách cho phép mọi user đều có quyền ghi

    try:
        # Bước 3: Sử dụng Python SQLite (vì máy bạn không có lệnh sqlite3 hệ thống)
        conn = sqlite3.connect(TMP_PATH)
        cursor = conn.cursor()
        
        # Logic xóa và chèn Cookie chuẩn
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        
        conn.commit()
        conn.close()
        print("\033[1;92m[ Rokid Manager ] - Cookie data updated in temporary file.\033[0m")
    except Exception as e:
        print(f"\033[1;91m[ Rokid Manager ] - Error editing database: {e}\033[0m")
        return False

    # Bước 4: Trả file về hệ thống và FIX QUYỀN SỞ HỮU (Chown)
    # Lấy UID của app để Roblox không bị Logout
    uid_res = run_cmd(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    uid = uid_res.stdout.strip() if uid_res.returncode == 0 else "10100:10100"

    run_cmd(f"cp {TMP_PATH} {DB_PATH}")
    run_cmd(f"chown {uid} {DB_PATH}")
    run_cmd(f"chmod 660 {DB_PATH}")
    run_cmd(f"rm {TMP_PATH}")
    
    print("\033[1;92m[ Rokid Manager ] - Injection process completed successfully!\033[0m")
    return True

def launch_roblox_logic():
    """Bê nguyên logic từ hàm launch_roblox trong file improvev2.py (dòng 1018)"""
    server_link = f"roblox://placeID={PLACE_ID}"
    
    print(f"\033[1;96m[ Rokid Manager ] - Opening Roblox for {PACKAGE_NAME}...\033[0m")
    # Bước khởi động 1: ActivitySplash (Dòng 1024)
    run_cmd(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {server_link}")
    
    # Chờ Splash load (Sử dụng 5s cho ổn định)
    time.sleep(5)

    print(f"\033[1;96m[ Rokid Manager ] - Joining Roblox for {PACKAGE_NAME}...\033[0m")
    # Bước khởi động 2: ActivityProtocolLaunch (Dòng 1030)
    run_cmd(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {server_link}")
    
    # Chờ 20s để vào hẳn game như trong file gốc
    time.sleep(20)
    print("\033[1;92m[ Rokid Manager ] - Joined Roblox successfully!\033[0m")

if __name__ == "__main__":
    # Thực hiện tuần tự đúng logic
    if inject_cookie_logic():
        launch_roblox_logic()
