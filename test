import subprocess
import sqlite3
import os
import time

# ================= C·∫§U H√åNH (B√ä NGUY√äN TH√îNG TIN C·ª¶A B·∫†N) =================
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PLACE_ID = "8737602449" 
PACKAGE_NAME = "com.roblox.clieng" 

# ƒê∆∞·ªùng d·∫´n h·ªá th·ªëng v√† v√πng t·∫°m (D√πng /data/local/tmp ƒë·ªÉ an to√†n)
REAL_DB = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"
TEMP_DB = "/data/local/tmp/cookies_work.db" 
# =========================================================================

def run_tsu(command):
    """Th·ª±c thi l·ªánh shell v·ªõi quy·ªÅn Root th√¥ng qua tsu"""
    return subprocess.run(['tsu', '-c', command], capture_output=True, text=True)

def main_process():
    print(f"\033[1;96m[ Rokid Manager ] - Kh·ªüi ch·∫°y quy tr√¨nh cho: {PACKAGE_NAME}\033[0m")

    # B∆Ø·ªöC 1: T·∫Øt app (logic Rokid Manager)
    run_tsu(f"am force-stop {PACKAGE_NAME}")
    time.sleep(1)

    # B∆Ø·ªöC 2: COPY FILE RA NGO√ÄI (Quy tr√¨nh b·∫°n y√™u c·∫ßu)
    print("üìÇ 1. ƒêang copy database ra v√πng t·∫°m b·∫±ng tsu...")
    run_tsu(f"rm -f {TEMP_DB}") # X√≥a file c≈© n·∫øu c√≥
    run_tsu(f"cp {REAL_DB} {TEMP_DB}")
    
    # B∆Ø·ªöC 3: FIX L·ªñI READONLY (C·ª±c k·ª≥ quan tr·ªçng)
    # C·∫•p quy·ªÅn 777 cho file copy ƒë·ªÉ ti·∫øn tr√¨nh Python c√≥ th·ªÉ M·ªû v√† GHI
    run_tsu(f"chmod 777 {TEMP_DB}")

    # B∆Ø·ªöC 4: D√ôNG PYTHON S·ª¨A FILE T·∫†I V√ôNG T·∫†M
    print("üîß 2. Python ƒëang th·ª±c hi·ªán s·ª≠a n·ªôi dung file t·∫°m...")
    try:
        # Python k·∫øt n·ªëi t·ªõi TEMP_DB (ƒë√£ chmod 777 n√™n s·∫Ω KH√îNG b·ªã readonly)
        conn = sqlite3.connect(TEMP_DB)
        cursor = conn.cursor()
        
        # Logic x√≥a v√† n·∫°p cookie chu·∫©n c·ªßa Roblox
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        
        conn.commit()
        conn.close()
        print("‚úÖ ƒê√£ s·ª≠a xong d·ªØ li·ªáu trong file t·∫°m.")
    except Exception as e:
        print(f"‚ùå Python v·∫´n kh√¥ng th·ªÉ ghi file (L·ªói: {e})")
        return

    # B∆Ø·ªöC 5: PASTE L·∫†I V√ÄO H·ªÜ TH·ªêNG
    print("üì• 3. ƒêang paste file ƒë√£ s·ª≠a tr·ªü l·∫°i h·ªá th·ªëng...")
    
    # L·∫•y UID c·ªßa app ƒë·ªÉ tr·∫£ l·∫°i quy·ªÅn s·ªü h·ªØu (Logic stat trong improvev2.py)
    uid_res = run_tsu(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    uid = uid_res.stdout.strip() if uid_res.returncode == 0 else "10100:10100"

    run_tsu(f"cp {TEMP_DB} {REAL_DB}")
    run_tsu(f"chown {uid} {REAL_DB}") # Tr·∫£ file cho app
    run_tsu(f"chmod 660 {REAL_DB}")
    
    # X√≥a file nh·∫≠t k√Ω ƒë·ªÉ bu·ªôc app n·∫°p database m·ªõi s·∫°ch ho√†n to√†n
    run_tsu(f"rm -f {REAL_DB}-wal")
    run_tsu(f"rm -f {REAL_DB}-shm")
    run_tsu(f"rm {TEMP_DB}")

    # B∆Ø·ªöC 6: LAUNCH GAME (B√ä NGUY√äN LOGIC D√íNG 1018-1030 TRONG FILE B·∫†N G·ª¨I)
    print(f"\033[1;96m[ Rokid Manager ] - ƒêang tham gia Game ID: {PLACE_ID}...\033[0m")
    server_link = f"roblox://placeID={PLACE_ID}"
    
    # B∆∞·ªõc 1: ActivitySplash (N·∫°p t√†i nguy√™n - D√≤ng 1024)
    run_tsu(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {server_link}")
    time.sleep(5)

    # B∆∞·ªõc 2: ActivityProtocolLaunch (V√†o th·∫≥ng server - D√≤ng 1030)
    run_tsu(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {server_link}")
    
    print("\033[1;92m[ Rokid Manager ] - Ho√†n t·∫•t! Ch√∫c b·∫°n farm vui v·∫ª.\033[0m")

if __name__ == "__main__":
    main_process()
