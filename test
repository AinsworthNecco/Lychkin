import subprocess
import sqlite3
import os
import time

# ================= C·∫§U H√åNH (D·ª∞A TR√äN Y√äU C·∫¶Ua) =================
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PLACE_ID = "8737602449" 
PACKAGE_NAME = "com.roblox.clieng" # T√™n package b·∫°n ƒë√£ cung c·∫•p

# Logic ƒë∆∞·ªùng d·∫´n t·ª´ file improvev2.py
DB_PATH = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"
TMP_PATH = "/data/local/tmp/Cookies_work" # S·ª≠ d·ª•ng v√πng nh·ªõ t·∫°m trung gian
# =============================================================

def run_root(command):
    """Th·ª±c thi l·ªánh shell v·ªõi quy·ªÅn Root (su) gi·ªëng improvev2.py"""
    return subprocess.run(['su', '-c', command], capture_output=True, text=True)

def get_package_uid():
    """Logic l·∫•y UID ƒë·ªÉ fix quy·ªÅn s·ªü h·ªØu sau khi ghi file"""
    result = run_root(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    return result.stdout.strip() if result.returncode == 0 else "10100:10100"

def clean_and_prepare():
    print(f"üßπ ƒêang d·ªçn d·∫πp ti·∫øn tr√¨nh {PACKAGE_NAME}...")
    # Logic: T·∫Øt app tr∆∞·ªõc khi ch·∫°m v√†o database
    run_root(f"am force-stop {PACKAGE_NAME}")
    # X√≥a c√°c file lock/journal ƒë·ªÉ tr√°nh l·ªói readonly
    run_root(f"rm -f {DB_PATH}-wal")
    run_root(f"rm -f {DB_PATH}-shm")
    run_root(f"rm -f {TMP_PATH}")
    time.sleep(1)

def inject_cookie():
    try:
        # B∆∞·ªõc 1: Copy file g·ªëc ra v√πng t·∫°m v√† c·∫•p quy·ªÅn ghi cho Python
        print("üìÇ Tr√≠ch xu·∫•t database...")
        run_root(f"cp {DB_PATH} {TMP_PATH}")
        run_root(f"chmod 777 {TMP_PATH}")

        # B∆∞·ªõc 2: D√πng Python SQLite m·ªü file t·∫°m (kh√¥ng b·ªã readonly v√¨ ƒë√£ chmod 777)
        print("üíæ ƒêang n·∫°p Cookie v√†o SQLite...")
        conn = sqlite3.connect(TMP_PATH)
        cursor = conn.cursor()
        
        # ƒê·ªìng b·ªô logic ghi ƒë√® cookie
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"‚ùå L·ªói ghi database: {e}")
        return False

def launch_logic_from_file():
    """
    √Åp d·ª•ng ch√≠nh x√°c Logic t·ª´ h√†m launch_roblox trong improvev2.py
    D√≤ng 1024 v√† 1030 trong file b·∫°n g·ª≠i
    """
    print(f"üéÆ ƒêang Rejoin v√†o Place ID: {PLACE_ID}...")
    server_link = f"roblox://placeID={PLACE_ID}"
    
    # B∆∞·ªõc 1: Kh·ªüi ch·∫°y ActivitySplash (D√≤ng 1024)
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {server_link}")
    print("‚è≥ Ch·ªù Splash Screen (4s)...")
    time.sleep(4) 

    # B∆∞·ªõc 2: K√≠ch ho·∫°t ActivityProtocolLaunch ƒë·ªÉ v√†o th·∫≥ng server (D√≤ng 1030)
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {server_link}")
    print("‚úÖ ƒê√£ g·ª≠i l·ªánh tham gia server.")

def main():
    clean_and_prepare()
    
    if inject_cookie():
        # Tr·∫£ file v·ªÅ v√† set quy·ªÅn s·ªü h·ªØu ƒë√∫ng UID c·ªßa app
        uid = get_package_uid()
        run_root(f"cp {TMP_PATH} {DB_PATH}")
        run_root(f"chown {uid} {DB_PATH}")
        run_root(f"chmod 660 {DB_PATH}")
        run_root(f"rm {TMP_PATH}")
        
        # Th·ª±c hi·ªán logic kh·ªüi ƒë·ªông t·ª´ file
        launch_logic_from_file()
        print("‚ú® Ho√†n t·∫•t quy tr√¨nh!")
    else:
        print("‚ö†Ô∏è Quy tr√¨nh th·∫•t b·∫°i, kh√¥ng th·ªÉ n·∫°p cookie.")

if __name__ == "__main__":
    main()
