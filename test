import subprocess
import sqlite3
import os
import time

# ================= C·∫§U H√åNH C·ª¶A B·∫†N =================
# 1. D√°n Cookie .ROBLOSECURITY c·ªßa b·∫°n v√†o ƒë√¢y
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"

# 2. Th√¥ng tin b·∫°n ƒë√£ cung c·∫•p
PLACE_ID = "8737602449" 
PACKAGE_NAME = "com.roblox.clieng"

# ƒê∆∞·ªùng d·∫´n database (T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh theo Package Name)
DB_PATH = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"
# ƒê∆∞·ªùng d·∫´n d·ª± ph√≤ng n·∫øu kh√¥ng th·∫•y file ·ªü tr√™n:
DB_PATH_ALT = f"/data/data/{PACKAGE_NAME}/app_webview/Cookies"

TMP_PATH = "/data/local/tmp/Cookies_tmp"
# ====================================================

def run_root(command):
    """Th·ª±c thi l·ªánh shell v·ªõi quy·ªÅn Root (su)"""
    return subprocess.run(['su', '-c', command], capture_output=True, text=True)

def get_uid():
    """L·∫•y UID c·ªßa ·ª©ng d·ª•ng ƒë·ªÉ fix quy·ªÅn s·ªü h·ªØu file"""
    result = run_root(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    if result.returncode == 0:
        return result.stdout.strip()
    return "10100:10100"

def start_process():
    print(f"üöÄ Kh·ªüi ƒë·ªông ƒëƒÉng nh·∫≠p cho Package: {PACKAGE_NAME}")
    print(f"üéÆ M·ª•c ti√™u Game ID: {PLACE_ID}")

    # B∆∞·ªõc 1: T·∫Øt ·ª©ng d·ª•ng
    run_root(f"am force-stop {PACKAGE_NAME}")
    time.sleep(1)

    # B∆∞·ªõc 2: Tr√≠ch xu·∫•t Database ra v√πng ƒë·ªám
    print("üìÇ ƒêang tr√≠ch xu·∫•t d·ªØ li·ªáu...")
    cp_cmd = run_root(f"cp {DB_PATH} {TMP_PATH}")
    if cp_cmd.returncode != 0:
        # Th·ª≠ ƒë∆∞·ªùng d·∫´n d·ª± ph√≤ng
        run_root(f"cp {DB_PATH_ALT} {TMP_PATH}")
    
    run_root(f"chmod 777 {TMP_PATH}")

    # B∆∞·ªõc 3: S·ª≠a Cookie b·∫±ng th∆∞ vi·ªán Python n·ªôi b·ªô (Kh√¥ng c·∫ßn l·ªánh sqlite3 h·ªá th·ªëng)
    try:
        conn = sqlite3.connect(TMP_PATH)
        cursor = conn.cursor()
        
        # X√≥a cookie c≈©
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        # Ch√®n cookie m·ªõi c·ªßa b·∫°n
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        
        conn.commit()
        conn.close()
        print("‚úÖ ƒê√£ c·∫≠p nh·∫≠t Cookie th√†nh c√¥ng v√†o file t·∫°m.")
    except Exception as e:
        print(f"‚ùå L·ªói SQLite Python: {e}")
        return

    # B∆∞·ªõc 4: Ghi ƒë√® l·∫°i h·ªá th·ªëng v√† Fix quy·ªÅn s·ªü h·ªØu
    print("üì• ƒêang n·∫°p d·ªØ li·ªáu v√†o ·ª©ng d·ª•ng...")
    uid = get_uid()
    run_root(f"cp {TMP_PATH} {DB_PATH}")
    run_root(f"chmod 660 {DB_PATH}")
    run_root(f"chown {uid} {DB_PATH}") # C·ª±c k·ª≥ quan tr·ªçng ƒë·ªÉ Roblox kh√¥ng b·ªã Logout

    # B∆∞·ªõc 5: Rejoin v√†o Server
    run_root(f"rm {TMP_PATH}")
    print(f"üöÄ ƒêang m·ªü Roblox v√† v√†o game...")
    game_url = f"roblox://placeID={PLACE_ID}"
    
    # G·ª≠i Intent m·ªü game
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {game_url}")
    time.sleep(5)
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {game_url}")

    print("‚ú® Ho√†n t·∫•t! Ch√∫c b·∫°n farm vui v·∫ª.")

if __name__ == "__main__":
    start_process()
