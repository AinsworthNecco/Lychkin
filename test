import os
import sqlite3
import subprocess
import time
import sys
import urllib.request

# --- Cấu hình ---
PACKAGE_NAME = "com.roblox.clieng"  # Tên package theo yêu cầu
PLACE_ID = "8737602449"            # ID Game để join
# URL chứa cookie của bạn
COOKIE_URL = "https://raw.githubusercontent.com/AinsworthNecco/Lychkin/refs/heads/main/cookie"

DB_PATH = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"

def elevate_to_root():
    """Tự động cấp quyền root qua tsu nếu chưa có"""
    if os.getuid() != 0:
        print("\033[1;33m[*] Đang tự động cấp quyền root qua tsu...\033[0m")
        try:
            # Thực thi lại chính script này bằng quyền root qua tsu
            os.execvp("tsu", ["tsu", "-c", f"python3 {os.path.abspath(__file__)}"])
        except Exception as e:
            print(f"\033[1;31m[!] Không thể tự cấp quyền root: {e}\033[0m")
            sys.exit(1)

def fetch_cookie_from_url(url):
    """Tải cookie trực tiếp từ GitHub"""
    print(f"\033[1;34m[*] Đang lấy cookie từ URL...\033[0m")
    try:
        with urllib.request.urlopen(url) as response:
            cookie = response.read().decode('utf-8').strip()
            if cookie:
                print("\033[1;32m[+] Đã tải cookie thành công!\033[0m")
                return cookie
            else:
                print("\033[1;31m[!] Lỗi: Nội dung cookie trống.\033[0m")
                return None
    except Exception as e:
        print(f"\033[1;31m[!] Lỗi khi kết nối đến GitHub: {e}\033[0m")
        return None

def run_command(command):
    """Chạy lệnh shell dưới quyền root"""
    try:
        result = subprocess.run(command, shell=True, capture_output=True, text=True)
        return result.stdout.strip()
    except Exception as e:
        return f"Lỗi: {e}"

def inject_cookie(cookie_value):
    """Chèn cookie vào database SQLite của ứng dụng"""
    print(f"\033[1;34m[*] Đang chèn cookie vào {PACKAGE_NAME}...\033[0m")
    
    try:
        # Cấp quyền truy cập file database
        run_command(f"chmod 666 {DB_PATH}")
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        expiry = int((time.time() + 31536000) * 1000000)
        now = int(time.time() * 1000000)

        # Xóa cookie cũ để tránh xung đột
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        # Chèn cookie mới vào bảng cookies của WebView
        query = """
        INSERT INTO cookies (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc)
        VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', ?, 1, 1, ?)
        """
        cursor.execute(query, (now, cookie_value, expiry, now))
        
        conn.commit()
        conn.close()
        
        # Trả lại quyền file
        run_command(f"chmod 600 {DB_PATH}")
        print("\033[1;32m[+] Inject Cookie thành công!\033[0m")
        return True
    except Exception as e:
        print(f"\033[1;31m[!] Lỗi Database (Kiểm tra xem app đã cài chưa): {e}\033[0m")
        return False

def launch_roblox():
    """Khởi động Roblox và tự động vào game"""
    print(f"\033[1;34m[*] Đang khởi động {PACKAGE_NAME} để join {PLACE_ID}...\033[0m")
    
    # Sử dụng intent roblox:// để join game
    join_url = f"roblox://placeId={PLACE_ID}"
    cmd = f"am start -a android.intent.action.VIEW -d '{join_url}' -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash"
    
    run_command(cmd)
    print("\033[1;32m[+] Đã gửi lệnh join game!\033[0m")

def main():
    os.system("clear")
    print("\033[1;36m======================================")
    print("    ROBLOX AUTO-FETCH & INJECT        ")
    print("======================================\033[0m")
    
    # 0. Tự động lấy quyền root qua tsu
    elevate_to_root()

    # 1. Tải cookie mới nhất từ GitHub
    cookie = fetch_cookie_from_url(COOKIE_URL)
    if not cookie:
        print("\033[1;31m[!] Không thể tiếp tục vì không có cookie.\033[0m")
        return

    # 2. Đóng Roblox nếu đang mở
    print(f"[*] Đang đóng {PACKAGE_NAME}...")
    run_command(f"am force-stop {PACKAGE_NAME}")
    time.sleep(1)

    # 3. Chèn cookie vào hệ thống
    if inject_cookie(cookie):
        # 4. Mở game
        launch_roblox()
    
    print("\n\033[1;33mQuy trình hoàn tất.\033[0m")

if __name__ == "__main__":
    main()
