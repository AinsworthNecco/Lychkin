import subprocess
import sqlite3
import os
import time

# ================= C·∫§U H√åNH C·ª®NG =================
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PLACE_ID = "8737602449" 
PACKAGE_NAME = "com.roblox.clieng" 

# File t·∫°m ƒë·ªÉ s·ª≠a (ƒë·∫∑t ·ªü n∆°i an to√†n h∆°n)
TEMP_DB = "/data/local/tmp/work_cookies.db"
# =================================================

def run_root(command):
    """S·ª≠ d·ª•ng 'su' ƒë·ªÉ th·ª±c thi l·ªánh Root"""
    return subprocess.run(['su', '-c', command], capture_output=True, text=True)

def find_real_db_path():
    """Logic t√¨m ki·∫øm file Cookies ch√≠nh x√°c (t∆∞∆°ng t·ª± file tham kh·∫£o)"""
    possible_paths = [
        f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies",
        f"/data/data/{PACKAGE_NAME}/app_webview/Cookies",
        f"/data/data/{PACKAGE_NAME}/databases/Cookies"
    ]
    for path in possible_paths:
        check = run_root(f"ls {path}")
        if check.returncode == 0:
            return path
    return None

def get_app_uid():
    res = run_root(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    return res.stdout.strip() if res.returncode == 0 else "10100:10100"

def start_injection():
    print(f"\033[1;96m[ Rokid Manager ] - ƒêang t√¨m ki·∫øm d·ªØ li·ªáu cho {PACKAGE_NAME}...\033[0m")
    
    # 1. T√¨m ƒë∆∞·ªùng d·∫´n th·ª±c t·∫ø
    real_db = find_real_db_path()
    if not real_db:
        print("\033[1;91m‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y file Cookies. H√£y m·ªü Roblox v√† ƒëƒÉng nh·∫≠p th·ªß c√¥ng 1 l·∫ßn.\033[0m")
        return

    print(f"üìÇ ƒê√£ t√¨m th·∫•y: {real_db}")

    # 2. T·∫Øt app v√† d·ªçn d·∫πp
    run_root(f"am force-stop {PACKAGE_NAME}")
    run_root(f"rm -f {real_db}-wal {real_db}-shm {TEMP_DB}")
    time.sleep(1)

    # 3. Copy ra v√† CHMOD 777 (C·ª±c k·ª≥ quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói unable to open)
    run_root(f"cp {real_db} {TEMP_DB}")
    run_root(f"chmod 777 {TEMP_DB}")
    
    # Ki·ªÉm tra xem file ƒë√£ ƒë∆∞·ª£c copy th√†nh c√¥ng ch∆∞a
    if not os.path.exists(TEMP_DB) or os.path.getsize(TEMP_DB) == 0:
        print("\033[1;91m‚ùå L·ªói: Kh√¥ng th·ªÉ tr√≠ch xu·∫•t file database ra v√πng t·∫°m.\033[0m")
        return

    # 4. S·ª≠a file b·∫±ng SQLite Python
    try:
        print("üîß ƒêang ghi ƒë√® Cookie...")
        conn = sqlite3.connect(TEMP_DB)
        cursor = conn.cursor()
        cursor.execute("DELETE FROM cookies WHERE host_key = '.roblox.com' AND name = '.ROBLOSECURITY'")
        
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        conn.commit()
        conn.close()
        print("‚úÖ ƒê√£ chu·∫©n b·ªã xong d·ªØ li·ªáu m·ªõi.")
    except Exception as e:
        print(f"‚ùå L·ªói SQLite: {e}")
        return

    # 5. Paste ng∆∞·ª£c l·∫°i v√† FIX QUY·ªÄN (Logic d√≤ng 1100+)
    uid = get_app_uid()
    run_root(f"cp {TEMP_DB} {real_db}")
    run_root(f"chown {uid} {real_db}")
    run_root(f"chmod 660 {real_db}")
    run_root(f"rm {TEMP_DB}")

    # 6. M·ªü Game (B√™ nguy√™n logic launch_roblox d√≤ng 1018)
    print(f"\033[1;96m[ Rokid Manager ] - ƒêang kh·ªüi ƒë·ªông Roblox & Rejoin...\033[0m")
    link = f"roblox://placeID={PLACE_ID}"
    
    # B∆∞·ªõc 1: ActivitySplash (D√≤ng 1024)
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {link}")
    time.sleep(5)

    # B∆∞·ªõc 2: ActivityProtocolLaunch (D√≤ng 1030)
    run_root(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {link}")
    
    print("\033[1;92m‚ú® Ho√†n t·∫•t! T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c n·∫°p th√†nh c√¥ng.\033[0m")

if __name__ == "__main__":
    start_injection()
