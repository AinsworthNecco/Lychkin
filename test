import subprocess
import time
import os

# ================== CẤU HÌNH ==================
PACKAGE = "com.roblox.clieng"
COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PLACE_ID = "8737602449"

DB_DIR = f"/data/data/{PACKAGE}/app_webview/Default"
ORIG_DB = f"{DB_DIR}/Cookies"
TMP_SQL = "/data/local/tmp/cookies_dump.sql"
NEW_DB = "/data/local/tmp/Cookies"
# =============================================

def su(cmd):
    return subprocess.run(
        ["su", "-c", cmd],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

def fatal(msg):
    print(f"[!] {msg}")
    exit(1)

def inject_cookie():
    print("[*] Stopping Roblox")
    su(f"am force-stop {PACKAGE}")
    time.sleep(1)

    if su(f"test -f {ORIG_DB}").returncode != 0:
        fatal("Cookies DB not found. Open Roblox once first.")

    print("[*] Dumping original cookie DB")
    su(f"sqlite3 {ORIG_DB} .dump > {TMP_SQL}")

    print("[*] Creating new writable cookie DB")
    su(f"rm -f {NEW_DB}")
    su(f"sqlite3 {NEW_DB} < {TMP_SQL}")

    print("[*] Injecting .ROBLOSECURITY cookie")
    su(f"""
    sqlite3 {NEW_DB} "
    DELETE FROM cookies WHERE name='.ROBLOSECURITY';
    INSERT INTO cookies
    (host_key,name,value,path,expires_utc,is_secure,is_httponly)
    VALUES
    ('.roblox.com','.ROBLOSECURITY','{COOKIE}','/',253402300799,1,1);
    "
    """)

    print("[*] Replacing system cookie DB")
    su(f"rm -f {ORIG_DB}*")
    su(f"cp {NEW_DB} {ORIG_DB}")

    uid = su(f"stat -c '%u:%g' /data/data/{PACKAGE}").stdout.strip()
    su(f"chown {uid} {ORIG_DB}")
    su(f"chmod 600 {ORIG_DB}")
    su(f"restorecon {ORIG_DB}")

    print("[✓] Cookie login injected successfully")

def launch_roblox():
    link = f"roblox://placeID={PLACE_ID}"

    print("[*] Launching Roblox (Splash)")
    su(f"am start -n {PACKAGE}/com.roblox.client.startup.ActivitySplash -d {link}")
    time.sleep(5)

    print("[*] Joining game")
    su(f"am start -n {PACKAGE}/com.roblox.client.ActivityProtocolLaunch -d {link}")
    time.sleep(15)

    print("[✓] Roblox launched & logged in via cookie")

if __name__ == "__main__":
    inject_cookie()
    launch_roblox()
