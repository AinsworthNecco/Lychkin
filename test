import subprocess
import sqlite3
import os
import time

# ================= C·∫§U H√åNH C·ª¶A B·∫†N =================
MY_COOKIE = "_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_CAEaAhADIhwKBGR1aWQSFDEwNTAxOTk1ODgxOTczMjgzNDc1KAM.K_gMy3tCQ0KZxZlwirOxqpIwxATitqRN4aaka_b7n0b0qvn6Af-ZH2oyOoNXj3FoGe2u9_RDiUOD24ipW4SGBuYayFwIt5OzfiFAU8HzzIsVDz1GyfKRnn-X3vijUVqM9DQrNQEAONL4jtCX7cgZfNywQOrYxKqcQRg1eyy45g7lhz7flC7SVnhTMB7U9vcanh9CI4ixsHKvGZYtIKzEsvR5f0rjO9evtqURbortrkXq80pFAeZU2UVhnW4R8U85eO193zk_7pv8JaKcz_NklQhO2xxCmMipRstDe-M_fYhGtFltl4olXVagx7SYoUgX-UqYZgaRmGbmxt9LQC-uZJ_-yJZalxHNQGstudubVpcWQFUbPUUjZrnZSHXo2NL8nZORTNyosZJMShdK553t2eLBZv8ocnoCbpRUktt9z9Hsg8rx7G2SWF3ZpMdQFmDIIFymM5YQugkndXdzwqjtaRUYoMZ8XL8mjqPexp6W-rIMUUpMkhfFif9sgQVWP0UtmVAMcWgehGhMjnLxnWKm2i9NRByzjjfBO6mjqAdC3d2lfCCaa2ICWF5j3gWDBRsCuLKpg7uUYy-Vp_Bp00rNN4sGsSZ8yqA79mpmoHHFifwAycURfjtortETJH9nzYSYGwexcA"
PLACE_ID = "8737602449" 
PACKAGE_NAME = "com.roblox.clieng" 

# ƒê∆∞·ªùng d·∫´n database ch√≠nh x√°c
DB_PATH = f"/data/data/{PACKAGE_NAME}/app_webview/Default/Cookies"
TEMP_DB = "/data/local/tmp/cookies_final.db"
# ====================================================

def run_tsu(command):
    """S·ª≠ d·ª•ng tsu ƒë·ªÉ ch·∫°y l·ªánh Root"""
    return subprocess.run(['tsu', '-c', command], capture_output=True, text=True)

def get_app_info():
    """L·∫•y UID v√† GID c·ªßa ·ª©ng d·ª•ng Roblox"""
    res = run_tsu(f"stat -c '%u:%g' /data/data/{PACKAGE_NAME}")
    if res.returncode == 0:
        return res.stdout.strip()
    return "10100:10100"

def start_injection():
    print(f"\033[1;96m[ Rokid Manager ] - ƒêang x·ª≠ l√Ω t√†i kho·∫£n cho: {PACKAGE_NAME}\033[0m")

    # B∆Ø·ªöC 1: T·∫Øt app v√† X√ìA S·∫†CH file nh·∫≠t k√Ω (R·∫•t quan tr·ªçng)
    run_tsu(f"am force-stop {PACKAGE_NAME}")
    # N·∫øu kh√¥ng x√≥a 2 file n√†y, Roblox s·∫Ω KH√îNG ƒë·ªçc file Cookies ch√≠nh ta v·ª´a s·ª≠a
    run_tsu(f"rm -f {DB_PATH}-wal")
    run_tsu(f"rm -f {DB_PATH}-shm")
    time.sleep(1)

    # B∆Ø·ªöC 2: Copy ra v√πng t·∫°m ƒë·ªÉ s·ª≠a
    print("üìÇ Tr√≠ch xu·∫•t database ra v√πng t·∫°m...")
    run_tsu(f"cp {DB_PATH} {TEMP_DB}")
    run_tsu(f"chmod 777 {TEMP_DB}")

    # B∆Ø·ªöC 3: S·ª≠a file b·∫±ng Python SQLite
    try:
        conn = sqlite3.connect(TEMP_DB)
        cursor = conn.cursor()
        
        # X√≥a m·ªçi cookie li√™n quan ƒë·∫øn roblox c≈© ƒë·ªÉ tr√°nh xung ƒë·ªôt
        cursor.execute("DELETE FROM cookies WHERE host_key LIKE '%roblox.com%'")
        
        # Ch√®n cookie m·ªõi v·ªõi c√°c th√¥ng s·ªë chu·∫©n Chromium
        now = int(time.time())
        sql = """INSERT INTO cookies 
                 (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme) 
                 VALUES (?, '.roblox.com', '.ROBLOSECURITY', ?, '/', 253402300799, 1, 1, ?, 1, 1, 1, -1, 2)"""
        cursor.execute(sql, (now, MY_COOKIE, now))
        
        conn.commit()
        conn.close()
        print("‚úÖ ƒê√£ s·ª≠a file t·∫°m th√†nh c√¥ng.")
    except Exception as e:
        print(f"‚ùå L·ªói ghi d·ªØ li·ªáu: {e}")
        return

    # B∆Ø·ªöC 4: Paste l·∫°i v√† FIX quy·ªÅn s·ªü h·ªØu (Chown)
    print("üì• ƒêang ghi ƒë√® d·ªØ li·ªáu v√† thi·∫øt l·∫≠p quy·ªÅn h·∫°n...")
    uid_gid = get_app_info()
    
    run_tsu(f"cp {TEMP_DB} {DB_PATH}")
    # Ph·∫£i tr·∫£ file v·ªÅ ƒë√∫ng ch·ªß s·ªü h·ªØu l√† ·ª©ng d·ª•ng Roblox
    run_tsu(f"chown {uid_gid} {DB_PATH}")
    run_tsu(f"chmod 660 {DB_PATH}")
    
    # M·ªôt l·∫ßn n·ªØa x√≥a s·∫°ch file nh·∫≠t k√Ω ·ªü th∆∞ m·ª•c g·ªëc tr∆∞·ªõc khi m·ªü app
    run_tsu(f"rm -f {DB_PATH}-wal")
    run_tsu(f"rm -f {DB_PATH}-shm")
    run_tsu(f"rm {TEMP_DB}")

    # B∆Ø·ªöC 5: M·ªü Game (B√™ nguy√™n logic launch_roblox t·ª´ file improvev2.py)
    print(f"\033[1;96m[ Rokid Manager ] - ƒêang Rejoin v√†o Place ID: {PLACE_ID}...\033[0m")
    link = f"roblox://placeID={PLACE_ID}"
    
    # B∆∞·ªõc kh·ªüi ƒë·ªông 1 (D√≤ng 1024 trong file c·ªßa b·∫°n)
    run_tsu(f"am start -n {PACKAGE_NAME}/com.roblox.client.startup.ActivitySplash -d {link}")
    time.sleep(5)

    # B∆∞·ªõc kh·ªüi ƒë·ªông 2 (D√≤ng 1030 trong file c·ªßa b·∫°n)
    run_tsu(f"am start -n {PACKAGE_NAME}/com.roblox.client.ActivityProtocolLaunch -d {link}")
    
    print("\033[1;92m‚ú® Th√†nh c√¥ng! N·∫øu cookie c√≤n s·ªëng, b·∫°n s·∫Ω ƒë∆∞·ª£c v√†o game ngay.\033[0m")

if __name__ == "__main__":
    start_injection()
