--[[
    PHIÊN BẢN TỐI GIẢN
    Chức năng: Tìm và chiếm booth nhanh nhất có thể. Không có GUI, không có tính năng phụ.
]]

-- Khởi tạo tối thiểu cần thiết
repeat task.wait() until game:IsLoaded()
if game.PlaceId ~= 8737602449 and game.PlaceId ~= 8943844393 then return end

local cloneref = cloneref or function(o) return o end
local Players = cloneref(game:GetService("Players"))
local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
local Workspace = cloneref(game:GetService("Workspace"))
local LocalPlayer = Players.LocalPlayer
local Remotes

-- Tìm Remotes
pcall(function()
    for i, v in next, ReplicatedStorage:GetChildren() do
        if v.Name:find('Remote') and v:IsA('ModuleScript') then
            if pcall(function() require(v).Event('PromotionBlimpGiftbux'):FireServer() end) then
                Remotes = require(v)
                break
            end
        end
    end
end)

if not Remotes then return end -- Nếu không tìm thấy Remotes, dừng lại

-- Tìm MapUI (bao gồm cả logic dự phòng)
local boothLocation
local suc, shuffled = pcall(function() return Workspace:WaitForChild('MapUI', 2) end)
if not suc then
    boothLocation = LocalPlayer.PlayerGui:WaitForChild('MapUIContainer', 2):WaitForChild('MapUI', 2)
else
    boothLocation = shuffled
end

if not boothLocation then return end -- Nếu không tìm thấy MapUI, dừng lại

-- Tìm booth trống phù hợp
local unclaimedBoothNumber
local interactions = Workspace:WaitForChild("BoothInteractions")
local mainCheckPosition = Vector3.new(165.161, 0, 311.636)

for _, uiFrame in ipairs(boothLocation.BoothUI:GetChildren()) do
    if uiFrame.Details.Owner.Text == "unclaimed" then
        local boothNum = tonumber(uiFrame.Name:match("%d+"))
        if boothNum then
            local interactPart = interactions:FindFirstChild("BoothInteraction" .. boothNum)
            if interactPart and (Vector3.new(interactPart.Position.X, 0, interactPart.Position.Z) - mainCheckPosition).Magnitude < 92 then
                unclaimedBoothNumber = boothNum
                break -- Tìm thấy booth đầu tiên phù hợp là đủ
            end
        end
    end
end

if not unclaimedBoothNumber then return end -- Nếu không có booth trống, dừng lại

-- Claim booth và di chuyển
if pcall(function() Remotes.Event("ClaimBooth"):InvokeServer(unclaimedBoothNumber) end) then
    task.wait(1) -- Chờ server xác nhận

    -- Xác nhận lại claim thành công
    if not string.find(boothLocation.BoothUI:FindFirstChild("BoothUI" .. unclaimedBoothNumber).Details.Owner.Text, LocalPlayer.DisplayName) then
        return
    end

    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local humanoid = character:WaitForChild("Humanoid")
    local boothInteractPart = interactions:FindFirstChild("BoothInteraction" .. unclaimedBoothNumber)

    if boothInteractPart then
        local standPosition = boothInteractPart.CFrame * CFrame.new(0, 0, 3) -- Đứng trước booth 3 stud
        rootPart.CFrame = boothInteractPart.CFrame
        humanoid:MoveTo(standPosition.Position)
        
        if humanoid.MoveToFinished:Wait(5) then
            -- Xoay người về phía trung tâm
            rootPart.CFrame = CFrame.new(standPosition.Position, Vector3.new(mainCheckPosition.X, rootPart.Position.Y, mainCheckPosition.Z))
        end
    end
end
