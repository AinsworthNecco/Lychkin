-- =================================================================
--         SCRIPT SPIN ĐƠN GIẢN VỚI FLUENT UI
--         Tạo bởi Gemini theo yêu cầu của Lychkin
-- =================================================================

--# Lib
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/Fluent.lua"))()
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

--# Tên file để lưu cài đặt
local CONFIG_FILENAME = "LychkinSetting.txt"

--# Bảng chứa các cài đặt mặc định
local Options = {
    SpinEnabled = false, -- Trạng thái bật/tắt spin
    SpinSpeed = 10 -- Tốc độ spin mặc định
}

--# Hệ thống lưu và tải cài đặt
local canAccessFiles, writefile_func, readfile_func = pcall(function() return writefile, readfile end)

local function SaveSettings()
    if not canAccessFiles then return end
    pcall(function()
        local data = HttpService:JSONEncode(Options)
        writefile_func(CONFIG_FILENAME, data)
    end)
end

local function LoadSettings()
    if not canAccessFiles then return end
    local success, content = pcall(readfile_func, CONFIG_FILENAME)
    if success and content and #content > 0 then
        pcall(function()
            local savedOptions = HttpService:JSONDecode(content)
            if type(savedOptions) == "table" then
                for key, value in pairs(savedOptions) do
                    if Options[key] ~= nil then
                        Options[key] = value
                    end
                end
                print("Đã tải cài đặt từ " .. CONFIG_FILENAME)
            end
        end)
    end
end

-- Tải cài đặt ngay khi script bắt đầu
LoadSettings()

--# Cửa sổ giao diện
local Window = Fluent:CreateWindow({
    Title = "Lychkin Spinner",
    SubTitle = "v1.0",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 400),
    Acrylic = false, -- Tắt hiệu ứng mờ để nhẹ hơn
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

--# Tab chính
local MainTab = Window:AddTab({ Title = "Main", Icon = "loader-2" })

--# Logic xoay nhân vật
local spinConnection = nil

function StartSpin()
    local character = game.Players.LocalPlayer.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")

    if not humanoid or not humanoid.RootPart then return end

    -- Ngắt kết nối cũ nếu có để tránh chạy nhiều lần
    if spinConnection then
        spinConnection:Disconnect()
        spinConnection = nil
    end

    -- Tạo một kết nối mới với sự kiện RenderStepped để xoay mượt mà
    spinConnection = RunService.RenderStepped:Connect(function(deltaTime)
        -- Kiểm tra xem chức năng có còn được bật không
        if not Options.SpinEnabled then
            if spinConnection then
                spinConnection:Disconnect()
                spinConnection = nil
            end
            return
        end

        -- Tính toán góc xoay dựa trên tốc độ và thời gian giữa các khung hình
        local currentCFrame = humanoid.RootPart.CFrame
        local rotation = CFrame.Angles(0, math.rad(Options.SpinSpeed * deltaTime * 10), 0)
        humanoid.RootPart.CFrame = currentCFrame * rotation
    end)
end

function StopSpin()
    if spinConnection then
        spinConnection:Disconnect()
        spinConnection = nil
    end
end

--# Thêm các thành phần vào giao diện
MainTab:AddToggle("SpinToggle", {
    Title = "Bật/Tắt Spin",
    Description = "Khiến nhân vật của bạn xoay tròn.",
    Default = Options.SpinEnabled, -- Lấy giá trị đã tải
    Callback = function(Value)
        Options.SpinEnabled = Value -- Cập nhật trạng thái
        SaveSettings() -- Lưu lại ngay khi thay đổi

        if Value then
            StartSpin()
        else
            StopSpin()
        end
    end
})

MainTab:AddSlider("SpinSpeedSlider", {
    Title = "Tốc độ Spin",
    Description = "Điều chỉnh tốc độ xoay của nhân vật.",
    Min = 1,
    Max = 100,
    Default = Options.SpinSpeed, -- Lấy giá trị đã tải
    Suffix = " deg/s",
    Callback = function(Value)
        Options.SpinSpeed = Value -- Cập nhật tốc độ
        SaveSettings() -- Lưu lại ngay khi thay đổi
    end
})

--# Khởi chạy logic ban đầu
-- Nếu lần trước thoát ra mà spin đang bật, hãy bật lại nó
if Options.SpinEnabled then
    StartSpin()
end

print("Lychkin Spinner đã sẵn sàng!")
